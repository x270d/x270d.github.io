define(["jquery","ui","./select2"],function(a){!function(a){"use strict";a.widget("akado.checkAddress",{_create:function(){this._events(),this.$town=this.element.find(".check-address__form-town_select").find("select"),this.$address=this.element.find(".check-address__form-address_select"),this.$house=this.element.find(".check-address__form-house_select"),this.$button=this.element.find(".check-address__form-button").find("button"),this.$errortext="Улица не выбрана. Введите название улицы, затем выберите ее из выпадающего списка.",this._checkForm()},_events:function(){var b=this;this.element.find("select").select2({width:"100%"}),this._on({"change .check-address__form-town select":this._clearInputs}),this._on({"change .check-address__form-address_select":this._checkForm}),this._on({"change .check-address__form-house_select":this._checkForm}),this._on({"mouseleave .check-address__form-town":this._checkTown}),this._on({"keyup .check-address__form-address_select":this._getInfo}),this._on({"click .check-address__form-house_select":function(a){b._getInfo(a,"getHouse")}}),this._on({"keyup .check-address__form-house_select":this._getInfo}),this._on({"keydown .check-address__form-item input":this._getLength}),this._on({"click ._list-block li":this._setId}),this._on({"click .check-address__form-button button":this._sendForm}),a.subscribe("checkForm",function(){b._checkForm()}),a.subscribe("changeFocus",function(){b._changeFocus()}),a("body").on("click",".edit-address",function(){b._anotherAddress()}),a("body").on("click",function(c){!b.$house.is(":focus") && !b.$address.is(":focus") && b.element.find("._list-block").removeClass("_visible")})},_clearInputs:function(){this.$address.val(""),this.$house.val(""),this.$button.attr("",""),this.element.find("._list-block").removeClass("_visible")},_hideListBlock:function(b){a(b.currentTarget).parent().find("._list-block").removeClass("_visible"),a(b.currentTarget).parent().find("._list-block").removeClass("_keyNav")},_checkTown:function(){this.$address.removeAttr("disabled","disabled")},_changeFocus:function(){this.$house.focus(),this.$house.trigger("click"),this.$address.removeClass("_visible"),this._checkForm()},_getInfo:function(b,c){var d=this;if(40!=b.which&&39!=b.which&&38!=b.which&&37!=b.which&&13!=b.which){this.element.find(".check-address__form-town_select __select").attr("data-id",this.$town);var e="";a(b.currentTarget).hasClass("check-address__form-address_select")&&(e="get_streets",d.$address.attr("data-id",""),d.$house.val("").attr("data-id",""),d.element.find(".house__list-block").removeClass("_visible")),a(b.currentTarget).hasClass("check-address__form-house_select")&&(e="get_houses",d.$house.attr("data-id","")),"getHouse"==c&&(e="get_houses",d.$house.attr("data-id",""));var f={city_id:this.element.find("select").val(),street_id:this.$address.attr("data-id")||"",house_id:this.$house.attr("data-id")||"",action:e,street_input_value:this.$address.val(),house_input_value:this.$house.val()};this._checkForm(),this._request(b,f)}},_request:function(b,c){var d=this,e=c,f=this.element.find("form").attr("data-url");a(b.currentTarget).attr("data-val-length")!=a.trim(a(b.currentTarget).val().replace(" ","").length)&&a.ajax({type:"POST",url:f,data:e,success:function(a){var b="",c="";"get_streets"==e.action&&(b="address__list-block",c=a.streets),"get_houses"==e.action&&(b="house__list-block",c=a.houses),d.element.find("."+b).find("li").remove();for(var f in c)d.element.find("."+b).find("ul").append('<li data-id="'+c[f].id+'">'+c[f].value+"</li>");d.element.find("."+b).find("li").length?d.element.find("."+b).addClass("_visible"):d.element.find("."+b).removeClass("_visible")}})},_setId:function(b){a(b.currentTarget).closest(".check-address__form-item").find("input").attr("data-id",a(b.currentTarget).attr("data-id")),a(b.currentTarget).closest(".check-address__form-item").find("input").val(a(b.currentTarget).text()),a("._list-block").removeClass("_visible")},_sendForm:function(b){var c=this,d=this.element.find("form").attr("data-url"),e={city_id:this.element.find("select").val(),street_id:this.$address.attr("data-id")||"",house_id:this.$house.attr("data-id")||"",action:"checkaddress",street_input_value:this.$address.val(),house_input_value:this.$house.val()};if(this.$address.val().length>0&&this.$house.val().length>0){if(c.$button.removeAttr("disabled"),!this.$address.attr("data-id")){return a("<div>",{class:"top-plate"}).html(c.$errortext).appendTo("body").fadeIn(300).delay(7e3).fadeOut(300,function(){this.remove()}),!1}a.ajax({type:"POST",url:d,data:e,success:function(b){if(a("body").hasClass("_popupCheck"))if("N"==b.connected){var c=a(".site-nav__connection-button").attr("data-order-url");window.location.replace(c)}else{var c=a(".site-nav__connection-button").attr("href");window.location.replace(c)}else"success"==b.success&&window.location.reload()}})}return b.stopPropagation(),b.preventDefault(),!1},_getLength:function(b){if(40==b.which||38==b.which)return void a.publish("autocomplete",{keyCode:b.which});if(13==b.which)a.publish("selectHouse");else{var c=a.trim(a(b.currentTarget).val().replace(" ","").length);a(b.currentTarget).attr("data-val-length",c)}},_checkForm:function(){var a=this;this.$address.val().length>0&&this.$house.val().length>0?a.$button.removeAttr("disabled"):a.$button.attr("","")},_anotherAddress:function(){this.element.removeClass("_hidden"),this.element.parent().find(".connection__info-status-wrapper").addClass("_hidden")}})}(a)});